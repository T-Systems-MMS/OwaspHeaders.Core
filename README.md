# OwaspHeaders.Core
A .NET Core middleware for injecting the Owasp recommended HTTP Headers for increased security.

## Build status

[![Build Status](https://dev.azure.com/T-Systems-MMS/OwaspHeaders.Core/_apis/build/status/T-Systems-MMS.OwaspHeaders.Core?branchName=master)](https://dev.azure.com/T-Systems-MMS/OwaspHeaders.Core/_build/latest?definitionId=2&branchName=master)

## Licence Used
[![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](https://opensource.org/licenses/MIT)

See the contents of the LICENSE file for details

## Code of Conduct
ClacksMiddleware has a Code of Conduct which all contributors, maintainers and forkers must adhere to. When contributing, maintaining, forking or in any other way changing the code presented in this repository, all users must agree to this Code of Conduct.

See [Code of Conduct.md](Code-of-Conduct.md) for details.

## Pull Requests

[![PRs Welcome](https://img.shields.io/badge/PRs-welcome-brightgreen.svg?style=flat-square)](http://makeapullrequest.com)

Pull requests are welcome, but please take a moment to read the Code of Conduct before submitting them or commenting on any work in this repo.

# NuGet package

OwaspHeaders.Core is available as a NuGet package. The NuGet package can be accessed [here](https://dev.azure.com/T-Systems-MMS/OwaspHeaders.Core/_packaging?_a=package&feed=T-Systems-MMS&package=OwaspHeaders.Core&protocolType=NuGet)

# Development Logs

This repository forms the basis for a series of blog posts that I have written on the topic of ASP.NET Core middleware.

If you would like to read about how I have developed the code in this repository, please see the first in the blog post series entitled: [".NET Core Middleware â€“ OWASP Headers Part 1"](https://dotnetcore.gaprogman.com/2017/07/20/net-core-middleware-owasp-headers-part-1/)

# Description
A collection of ASP.NET Core middleware classes designed to increase web application security by adopting the recommended [OWASP](https://www.owasp.org/index.php/Main_Page) settings.

![OwaspHeaders.Core logo](OwaspHeaders.Core-Logo.png)

### Secure Headers
The `SecureHeadersMiddleware` is used to inject the HTTP headers recommended by the [OWASP Secure Headers](https://www.owasp.org/index.php/OWASP_Secure_Headers_Project) project into all responses generated by the ASP.NET Core pipeline.

#### Usage

Add a reference to the [NuGet package](https://dev.azure.com/T-Systems-MMS/OwaspHeaders.Core/_packaging?_a=package&feed=T-Systems-MMS&package=OwaspHeaders.Core&protocolType=NuGet) to your project.

Add the following nuget feed to your project:
`https://tfs.t-systems-mms.eu/scrum/_packaging/MMS.Internal/nuget/v3/index.json`

We recommend placing a Nuget.config with the following content in your solution-directory, so the feed source is shared between all developers cloning your repository :
```xml
<configuration>
    <packageSources>
         <add key="nuget.org" value="https://api.nuget.org/v3/index.json" protocolVersion="3" />
         <add key="MMS.Public" value="https://pkgs.dev.azure.com/T-Systems-MMS/_packaging/T-Systems-MMS/nuget/v3/index.json"/>
    </packageSources>
   <!-- Credentials are needed if you want to restore using an automated system or command line
    <packageSourceCredentials>
        <MMS.Public>
          <add key="Username" value="TFS" />      
          <add key="ClearTextPassword" value="Your Personal Access Token" />
        </MMS.Public>
     </packageSourceCredentials>
    -->
</configuration>
```

Now you can clone the package - if you don't want to hassle with authorization use the Visual Studio Wizard, otherwise you can get started with this command:
```bash
dotnet add package OwaspHeaders.Core --source "https://pkgs.dev.azure.com/T-Systems-MMS/_packaging/T-Systems-MMS/nuget/v3/index.json"
```

## Configuration

For both versions 1.x and 2.x, a `secureHeaderSettings.json` file was used. However, from version 3.x onwards, a build-time builder pattern is now used for configuring the secure headers.

Please see the following sections for how to configure the OwaspHeaders.Core middlware.

#### Configuration in Version 3.x

Version 3.x of OwaspHaders.Core no longer uses the `secureHeaderSettings.json` file as this is a runtime dependency. It now uses the builder pattern to set up the header information, which is a compile time dependency.

In your `Startup` class, add a using statement for the OwaspHeaders.Core middleware

``` csharp
using OwaspHeaders.Core.Extensions;
````

Then in the `Configure` method, add the following

``` charp
app.UseSecureHeadersMiddleware(SecureHeadersMiddlewareExtensions.BuildDefaultConfiguration());
```

This will use the default configuration for the OwaspHeaders.Core middleware. The method (found in `/src/Extensions/SecureHeadersMiddlewareExtensions.cs`) looks like this:

``` csharp
public static SecureHeadersMiddlewareConfiguration BuildDefaultConfiguration()
{
    return SecureHeadersMiddlewareBuilder
        .CreateBuilder()
        .UseHsts()
        .UseXFrameOptions()
        .UseXSSProtection()
        .UseContentTypeOptions()
        .UseContentDefaultSecurityPolicy()
        .UsePermittedCrossDomainPolicies()
        .UseReferrerPolicy()
        .Build();
}
```

In order to use a custom configuration, follow the same pattern (perhaps creating your own extension method to encapsulate it):

``` csharp
public static SecureHeadersMiddlewareConfiguration CustomConfiguration()
{
    return SecureHeadersMiddlewareBuilder
        .CreateBuilder()
        .UseHsts(1200, false)
        .UseXSSProtection(XssMode.oneReport, "https://reporturi.com/some-report-url")
        .UseContentDefaultSecurityPolicy()
        .UsePermittedCrossDomainPolicies(XPermittedCrossDomainOptionValue.masterOnly)
        .UseReferrerPolicy(ReferrerPolicyOptions.sameOrigin)
        .Build();
}
```

Then consume it in the following manner:

``` charp
app.UseSecureHeadersMiddleware(CustomSecureHeaderExtensions.CustomConfiguration());
```

#### Testing the Middleware

Run the application, request one of the pages that it serves and view the headers for the page.

This can be done in Google Chrome, using the Dev tools and checking the network tab.

![secure headers shown in network tab](screenshots/secure-headers-screenshot.png "Headers on the right-hand side here")

Shown above in the `Response Headers` section of the `Values` response.
